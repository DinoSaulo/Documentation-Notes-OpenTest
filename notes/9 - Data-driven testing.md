# [Data-driven testing](https://getopentest.org/docs/data-driven-testing.html)

## Conceitos principais

A metodologia de teste orientado a dados consiste em executar o mesmo teste algumas vezes usando diferentes valores de dados a cada nova iteração. Isso é benéfico para a cobertura de teste pois amplia ela com menos esforço de desenvolvimento. A abordagem orientada a dados também irá facilitar a adição de novas iterações, para isso basta apenas adicionar outro registro de dados ao conjunto de dados usado pelo teste. Os registros de dados devem ser armazenados em uma tabela (matriz) de dados, onde cada linha (registro) contém um ou mais campos que serão referenciados e usados no teste.

Abaixo temos um exemplo de um teste orientado a dados simples cuja fonte de dados (especificada na propriedade `dataSet`) consiste em três objetos que representam as pessoas que queremos cumprimentar. O teste será executado três vezes, uma vez para cada registro de dados da tabela de dados, e registrará uma saudação usando o nome armazenado no campo de `name` de cada registro.

`test-repo-path/tests/Data-driven.yaml`
```yaml
description: Um simples teste orientado por dados
dataSet: [ {name: Fred}, {name: Wilma}, {name: Pebbles} ]
actors:
  - actor: ACTOR1
    segments:
      - segment: 1
        actions:
          - description: Say hello
            script: |
              $log("Hello, " + $dataRecord.name + "!")
```

Há duas coisas importantes a serem observadas sobre o exemplo:

- Os registros das iterações são passados para o teste usando a propriedade `dataSet`. Essa propriedade geralmente vem acompanhada de uma matriz de objetos. Essa matriz pode ser especificada usando a sintaxe JSON ou qualquer variação da sintaxe YAML. Para conjuntos de dados mais complexos, os dados podem ser lidos de um arquivo de dados externo usando a sintaxe `$data`.

- A sintaxe `$dataRecord` é uma variável que aponta para o registro atual no conjunto de dados. O valor desta variável é atualizado por cada iteração, então, toda vez que o teste começar a ser executado ele irá apontar para o próximo objeto (registro) no conjunto de dados. Veremos melhor sobre isso abaixo.

## Usando arquivos de dados externos

Na vida real, os dados usados para os testes orientados por dados podem se tornar bastante complexos. Os conjuntos de dados podem se estender facilmente a dezenas ou centenas de registros, e cada registro de dados pode ter vários campos. Na linha do conjunto de dados, conforme mostrado no exemplo anterior, pode ser útil para fazer alguns experimentos rápidos ou solucionar problemas, mas não é prático na maioria das vezes. Em vez disso, devemos armazenar os dados em arquivos externos e fazer referência a esses arquivos usando a sintaxe `$data`. Vajamos ver como isso é feito.

Primeiro, deve ser criado um arquivo de dados YAML no diretório de dados do repositório de teste:

`test-repo-path/data/people.yaml`
```yaml
- name: Fred
  age: 36
  employed: yes
  occupation: crane operator

- name: Wilma
  age: 28
  employed: no
  occupation: housewife

- name: Pebbles
  age: 2
  employed: no
  occupation: infant
```

Agora podemos referenciar o arquivo de dados `people.yaml` em nosso teste. Para isso, vamos adicionar uma ação de script que realiza uma validação verificando a idade e os campos de cada um dos registros de dados.

`test-repo-path/tests/Data-driven.yaml`
```yaml
description: Um simples teste orientado por dados
dataSet: $data("people")
actors:
  - actor: ACTOR1
    segments:
      - segment: 1
        actions:
          - description: Say hello
            script: |
              $log("Hello, " + $dataRecord.name + "!")

          - description: Check minimum age of employment
            script: |
              if ($dataRecord.age < 14 && $dataRecord.employed == "yes") {
                $fail("Persons under 14 are not allowed to work!");
              }
```

## Trabalhando com dados em um arquivo CSV

Uma prática muito comum nas automações de teste é usar planilhas do Excel para armazenar os dados de teste. O Excel é uma ferramenta muito poderosa, quando usada corretamente. No entanto, o formato do arquivo Excel apresenta um aspecto fundamental: é um formato binário e não apenas um arquivo de texto. Para user arquivos do Excel como forma de armazenar dados e ferramenta de edição de dados, deve-se armazenar os dados usando o formato CSV. Pela documentação oficial do OpenTest, não é incentivado essa abordagem, mas é explicado que há momentos em que um formato de tabela é mais apropriado para os testes baseados em dados.

O arquvio CSV (valores separados por vírgula) é um formato de texto simples, onde os registros de dados são armazenados como linhas de texto e os valores de campo  são separados de outros registros através de vírgulas. Veja como o arquivo de dados `people.yaml` fica quando excrito no formato CSV:

`test-repo-path/data/people.csv`
```csv
name,age,employed,occupation
Fred,36,yes,crane operator
Wilma,28,no,housewife
Pebbles,2,no,infant
```

A primeira linha no arquivo CSSV é o cabeçalho da tabela, e contém os nomes das colunas de dados separados por virgulas. As linha seguintes do arquivo exibem os registros dos dados que serão iterados.

Para usar o arquivo CSV em vez de um arquivo YAML é necessário alterar a extensão do arquivo referenciado no paraâmetro `dataSet` para `.csv` ao especificar o nome do arquivo:

`test-repo-path/tests/Data-driven.yaml (trecho)`
```yaml
dataSet: $data("people.csv")
```

O OpenTest converterá os dados CSV na mesma estrutura de dados que tinhamos antes: uma matriz de objetos, onde cada objeto contem todos os campos (ou propriedades) definidos na linha de cabeçalho do arquivo.

### Qual o proximo passo?

Como atividade, crie e execute um teste simples baseado em dados:

Vá para o diretório `C:\opentest\test-repo\tests` e crie um arquivo chamado `Data-driven.yaml`. Copie e cole o conteúdo do primeiro bloco de código nesta página no novo arquivo criado.

Examine os resultados do teste e o arquivo de log.

Modifique o teste orientado a dados que foi criado na etapa anterior para que ele seja carregado o seu conjunto de dados do arquivo YAML externo:

Vá para o diretório `C:\opentest\test-repo\data` e crie um arquivo chamado `people.yaml`. Copie e cole os dados mostrados no primeiro bloco de código na seção "Usando arquivos de dados externos".

Por fim, altere a propriedade `dataSet` de forma que ele referencia o arquivo `Data-driven.yaml` para apontar para o arquivo de dados que foi criado. O código deverá ficar da seguinte forma: `$data("pessoas")`.